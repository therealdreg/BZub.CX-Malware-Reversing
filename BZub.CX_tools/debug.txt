R E V E R S I N G     W i n 3 2 / S p y . B Z u B
--------------------------------------------------
David Reguera Garcia - dreguera@s21sec.com
                     - david.reguera@inteco.es

v030165.exe
--------------------------------------------------

PEDUMP
..................................................
File Header
  Machine:                      014C (I386)
  Number of Sections:           0002
  TimeDateStamp:                472164DA -> Fri Oct 26 05:54:02 2007
  PointerToSymbolTable:         00000000
  NumberOfSymbols:              00000000
  SizeOfOptionalHeader:         00E0
  Characteristics:              010F
    RELOCS_STRIPPED
    EXECUTABLE_IMAGE
    LINE_NUMS_STRIPPED
    LOCAL_SYMS_STRIPPED
    32BIT_MACHINE

Optional Header
  Magic                         010B
  linker version                6.00
  size of code                  6000
  size of initialized data      F400
  size of uninitialized data    0
  entrypoint RVA                6094
  base of code                  1000
  base of data                  7000
  image base                    400000
  section align                 1000
  file align                    200
  required OS version           4.00
  image version                 0.00
  subsystem version             4.00
  Win32 Version                 0
  size of image                 17000
  size of headers               400
  checksum                      0
  Subsystem                     0002 (Windows GUI)
  DLL flags                     0000
  stack reserve size            100000
  stack commit size             1000
  heap reserve size             100000
  heap commit size              1000
  RVAs & sizes                  10

Data Directory
  EXPORT           rva: 00000000  size: 00000000
  IMPORT           rva: 000069D4  size: 000000A0
  RESOURCE         rva: 00007000  size: 0000F270
  EXCEPTION        rva: 00000000  size: 00000000
  SECURITY         rva: 00000000  size: 00000000
  BASERELOC        rva: 00000000  size: 00000000
  DEBUG            rva: 00000000  size: 00000000
  ARCHITECTURE     rva: 00000000  size: 00000000
  GLOBALPTR        rva: 00000000  size: 00000000
  TLS              rva: 00000000  size: 00000000
  LOAD_CONFIG      rva: 00000000  size: 00000000
  BOUND_IMPORT     rva: 00000000  size: 00000000
  IAT              rva: 00001000  size: 000001F8
  DELAY_IMPORT     rva: 00000000  size: 00000000
  COM_DESCRPTR     rva: 00000000  size: 00000000
  unused           rva: 00000000  size: 00000000

Section Table
  01 .text     VirtSize: 00005F94  VirtAddr:  00001000
    raw data offs:   00000400  raw data size: 00006000
    relocation offs: 00000000  relocations:   00000000
    line # offs:     00000000  line #'s:      00000000
    characteristics: E0000020
      CODE  EXECUTE  READ  WRITE  ALIGN_DEFAULT(16)

  02 .rsrc     VirtSize: 0000F270  VirtAddr:  00007000
    raw data offs:   00006400  raw data size: 0000F400
    relocation offs: 00000000  relocations:   00000000
    line # offs:     00000000  line #'s:      00000000
    characteristics: 40000040
      INITIALIZED_DATA  READ  ALIGN_DEFAULT(16)



Resources (RVA: 7000)
ResDir (0) Entries:01 (Named:01, ID:00) TimeDate:00000000
    --------------------------------------------------------------
    ResDir (RT_DLL) Entries:01 (Named:00, ID:01) TimeDate:00000000
        ResDir (82) Entries:01 (Named:00, ID:01) TimeDate:00000000
            ID: 00000409  DataEntryOffs: 00000048
            DataRVA: 07070  DataSize: 0F200  CodePage: 0


Imports Table:
  MFC42.DLL
  Import Lookup Table RVA:  00006ACC
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006C6C
  Import Address Table RVA: 00001058
  Ordn  Name
  5199
  2396
  3346
  5300
  5302
  2725
  4079
  4698
  5307
  5289
  5714
  2982
  3147
  3259
  4465
  3136
  3262
  1089
  3081
  2976
  3830
  3831
  3825
  3079
  4080
  4622
  4424
  3738
   561
   815
   926
  2764
  5856
  3922
  5731
  2512
  1576
  2554
  4486
  6375
  4274
   941
  2915
   823
   825
   924
   922
  4129
  1168
   354
  5186
  6385
   353
  5773
  5442
  1979
   665
   860
  5683
  6877
  6648
  4278
  1200
  6779
   939
   537
   540
   858
   800
  2985
   535

  MSVCRT.dll
  Import Lookup Table RVA:  00006BEC
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006CAC
  Import Address Table RVA: 00001178
  Ordn  Name
   183  _controlfp
   202  _except_handler3
   129  __set_app_type
   111  __p__fmode
   106  __p__commode
   157  _adjust_fdiv
   131  __setusermatherr
   271  _initterm
    88  __getmainargs
   143  _acmdln
   585  exit
    72  _XcptFilter
   211  _exit
   390  _onexit
    85  __dllonexit
   426  _setmbcp
   451  _strlwr
    73  __CxxFrameHandler
   345  _mbscmp
   241  _ftol
   720  time
   678  rand

  KERNEL32.dll
  Import Lookup Table RVA:  00006A90
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006E7E
  Import Address Table RVA: 0000101C
  Ordn  Name
   776  lstrlenA
   381  GetWindowsDirectoryA
   556  ResumeThread
    74  CreateThread
   163  FindResourceA
   294  GetModuleHandleA
   336  GetStartupInfoA
   370  GetUserDefaultLangID
   662  Sleep
    40  CopyFileA
   345  GetSystemDirectoryA
   292  GetModuleFileNameA
   661  SizeofResource
   455  LoadResource

  USER32.dll
  Import Lookup Table RVA:  00006C50
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006EB4
  Import Address Table RVA: 000011DC
  Ordn  Name
   478  PostMessageA
   309  GetParent
   399  IsWindow

  ADVAPI32.dll
  Import Lookup Table RVA:  00006A74
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006F28
  Import Address Table RVA: 00001000
  Ordn  Name
   356  RegDeleteValueA
   370  RegOpenKeyExA
   379  RegQueryValueExA
   351  RegCreateKeyExA
   390  RegSetValueExA
   347  RegCloseKey

  ole32.dll
  Import Lookup Table RVA:  00006C60
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006F58
  Import Address Table RVA: 000011EC
  Ordn  Name
   269  StringFromGUID2
    12  CoCreateGuid

  SHLWAPI.dll
  Import Lookup Table RVA:  00006C48
  TimeDateStamp:            00000000
  ForwarderChain:           00000000
  DLL Name RVA:             00006F72
  Import Address Table RVA: 000011D4
  Ordn  Name
   108  SHDeleteKeyA




REVERSING
..................................................
Llamada a la rutina donde comienza el troyano:
004061C3  |. E8 68000000    CALL v030165.00406230

Se llama a:
00406240  |. E8 43000000    CALL <JMP.&MFC42.#1576>

Pasandole como argumento:
0012FF18   00400000  v030165.00400000
0012FF1C   00000000
0012FF20   00141F35
0012FF24   0000000A

Que vienen a ser:
1) La base de la imagen del proceso.
2) NULL
.....

Despues de estar depurando un rato la llamada a la MFC se llega a un punto:
73D5454A   FF15 BC62DF73    CALL DWORD PTR DS:[<&KERNEL32.FindResourceA>] 
Y el marco de la pila queda:
0012FB94   73D50000  |hModule = 73D50000 (MFC42)
0012FB98   00000E01  |ResourceName = E01
0012FB9C   00000006  \ResourceType = RT_STRING

Se puede observar que durante el siguiente periodo de depuracion se crean
cadenas tales:
v030165.HLP
v030165.INI

73D5CFBC   FF15 AC62DF73    CALL DWORD PTR DS:[<&KERNEL32.GetCurrentThreadId>]
73D5CFC2   50               PUSH EAX
73D5CFC3   6A 00            PUSH 0
73D5CFC5   68 C750D573      PUSH MFC42.73D550C7
73D5CFCA   6A FF            PUSH -1
73D5CFCC   FF15 5866DF73    CALL DWORD PTR DS:[<&USER32.SetWindowsHookExA>] 

Marco de la pila:
0012FEDC   FFFFFFFF  |HookType = WH_MSGFILTER
0012FEE0   73D550C7  |Hookproc = MFC42.73D550C7
0012FEE4   00000000  |hModule = NULL
0012FEE8   0000097C  \ThreadID = 97C

Despues de seguir depurando por la MFC se llega de nuevo al modulo de v030165:
00405106   . B8 8C644000    MOV EAX,v030165.0040648C

Despues se llega a:
00405110   . B8 20100000    MOV EAX,1020

Cosa curiosa:
0040511D     BF 241C4000    MOV EDI,v030165.00401C24                            
;  ASCII "Typically, that's where no one dashes to rehab or uses the word "if." According to Slansky, conditional apologies usually fail, as when 
; Allen tried to apologize for calling an Indian-American man 
; "macaca" by saying, "If I had any idea it"...
00405122     BE 301B4000    MOV ESI,v030165.00401B30                            
;  ASCII "Sudan on Monday gave the AU a one-week ultimatum to accept a deal 
; that would block the proposed 20,000-member U.N. peacekeeping 
; force in Darfur or else leave the region, a step that would likely worsen 
; the world's worst humanitarian disa"...
00405127     8BC7           MOV EAX,EDI
00405129     8A10           MOV DL,BYTE PTR DS:[EAX]


004051B6   > 68 001B4000    PUSH v030165.00401B00                        
 ;  ASCII "C:\Program Files\Internet Explorer\IEXPLORE.EXE"

Deses de emempujar a la pila ese valor
llama a una MFC en la que se puede ver la cadena por la pila: 165.HLP
004051BE   . E8 AD0C0000    CALL <JMP.&MFC42.#537>

Despues se vuelve al modulo del troyano:
004051CD   . 68 EC1A4000    PUSH v030165.00401AEC                     
          ;  ASCII "Internet Explorer"
004051D2   . E8 990C0000    CALL <JMP.&MFC42.#537>
....

Luego se obtiene el lenguaje de la maquina por defecto:
0040523C . 8B35 38104000  MOV ESI,DWORD PTR DS:[<&KERNEL32.GetUserDefaultLang>
00405242 . C645 FC 02     MOV BYTE PTR SS:[EBP-4],2
00405246 . FFD6           CALL ESI                             
               ; [GetUserDefaultLangID

(Esto lo usan los troyanos para luego en el portal CZ Stats en este caso
poder catalogar las maquinas infectadas por paises).

En este caso se recibe en EDX el UNICODE de la maquina:
7F6F0824  45 00 53 00 4E                                   E.S.N

Siguiente sub rutina a prestar atencion:
0040202A  /$ 55             PUSH EBP
....


00402073  |. BE 20124000    MOV ESI,v030165.00401220                          
  ;  ASCII "06:54:01"
00402078  |. 8D0480         LEA EAX,DWORD PTR DS:[EAX+EAX*4]
0040207B  |. C1E0 06        SHL EAX,6
0040207E  |. 3945 FC        CMP DWORD PTR SS:[EBP-4],EAX
00402081  |. 75 0D          JNZ SHORT v030165.00402090
00402083  |. 394D FC        CMP DWORD PTR SS:[EBP-4],ECX
00402086  |. 75 08          JNZ SHORT v030165.00402090
00402088  |. 57             PUSH EDI
00402089  |. 57             PUSH EDI
0040208A  |. 56             PUSH ESI
0040208B  |. E8 F23D0000    CALL <JMP.&MFC42.#1200>
00402090  |> 8D85 F8FEFFFF  LEA EAX,DWORD PTR SS:[EBP-108]
00402096  |. 68 04010000    PUSH 104                                        
    ; /BufSize = 104 (260.)
0040209B  |. 50             PUSH EAX                                     
       ; |PathBuffer
0040209C  |. 57             PUSH EDI                                       
     ; |hModule
0040209D  |. FF15 48104000  CALL DWORD PTR DS:[<&KERNEL32.GetModuleFileNameA>]
Marco de la pila:
0012DDA0   00000000  |hModule = NULL
0012DDA4   0012EDB4  |PathBuffer = 0012EDB4
0012DDA8   00000104  \BufSize = 104 (260.)

En PathBuffer mete la ruta del troyano, en este caso:
0012EDB4  43 3A 5C 44 6F 63 75 6D 65 6E 74 73 20 61 6E 64  C:\Documents and
0012EDC4  20 53 65 74 74 69 6E 67 73 5C 41 64 6D 69 6E 69   Settings\Admini
0012EDD4  73 74 72 61 64 6F 72 5C 45 73 63 72 69 74 6F 72  strador\Escritor
0012EDE4  69 6F 5C 43 6F 70 69 61 20 64 65 20 76 30 33 30  io\Copia de v030
0012EDF4  31 36 35 2E 65 78 65 5C 76 30 33 30 31 36 35 2E  165.exe\v030165.
0012EE04  65 78 65                                         exe



004020A3 |. FF15 38104000 CALL DWORD PTR DS:[<&KERNEL32.GetUserDefaultLangID>>
Y obtenemos de nuevo la cadena ESN

0040211A  |. 50             PUSH EAX
0040211B  |. E8 803D0000    CALL <JMP.&MFC42.#860>
Marco de la pila:
0012DDA8   0012EDB4  ASCII "C:\Documents and Settings\Administrador\
Escritorio\Copia de v030165.exe\v030165.exe"

EN MFC:
73D60EF5   FF15 E061DF73    CALL DWORD PTR DS:[<&KERNEL32.GetFullPathNameA>] 
Marco:
0012EB88   00374F18  |FileName = "C:\Documents and Settings\Administrador\
Escritorio\Copia de v030165.exe\v030165.exe"
0012EB8C   00000104  |MaxPathSize = 104 (260.)
0012EB90   0012ED34  |Path = 0012ED34
0012EB94   0012EBA8  \pFilenameInPath = 0012EBA8

EN MFC:
73D60E6D   FF15 C463DF73    CALL DWORD PTR DS:[<&KERNEL32.CreateFileA>]         ; kernel32.CreateFileA
Marco:
0012ECF8   00374F18  |FileName = "C:\Documents and Settings\Administrador\Escritorio\Copia de v030165.exe\v030165.exe"
0012ECFC   80000000  |Access = GENERIC_READ
0012ED00   00000003  |ShareMode = FILE_SHARE_READ|FILE_SHARE_WRITE
0012ED04   0012ED20  |pSecurity = 0012ED20
0012ED08   00000003  |Mode = OPEN_EXISTING
0012ED0C   00000080  |Attributes = NORMAL
0012ED10   00000000  \hTemplateFile = NULL

MFC:
73D61208   FF15 9063DF73    CALL DWORD PTR DS:[<&KERNEL32.ReadFile>]     
Marco:
0012EE64   00000038  |hFile = 00000038
0012EE68   004068D0  |Buffer = v030165.004068D0
0012EE6C   000000D8  |BytesToRead = D8 (216.)
0012EE70   0012EE84  |pBytesRead = 0012EE84
0012EE74   00000000  \pOverlapped = NULL

DUMP de los BYTES LEIDOS:
79 69 70 7D 60 23 0B 1E 23 64 4A 0E E7 DE F0 87 72 44 21 47 F9 D7 82 7E 6F 12 
8A A9 78 39 84 C1 00 41 84 C9 10 59 A4 F1 40 91 E4 39 90 E9 44 A1 00 61 C4 29 
90 F9 64 D1 40 B1 24 99 10 89 04 81 00 81 04 89 10 99 24 B1 40 D1 64 F9 90 29 
C4 61 00 A1 44 E9 90 39 E4 91 40 F1 A4 59 10 C9 84 41 00 C1 84 49 10 D9 A4 71 
40 11 E4 B9 90 69 44 21 00 E1 C4 A9 90 79 64 51 40 31 24 19 10 09 04 01 00 01 
04 09 10 19 24 31 40 51 64 79 90 A9 C4 E1 00 21 44 69 90 B9 E4 11 40 71 A4 D9 
10 49 84 C1 00 41 84 C9 10 59 A4 F1 40 91 E4 39 90 E9 44 A1 00 61 C4 29 90 F9 
64 D1 40 B1 24 99 10 89 04 81 00 81 04 89 10 99 24 B1 40 D1 64 F9 90 29 C4 61 
9A 38 DD 70 09 A0 2D AE 00

el hFile es el del propio troyano.

Estos datos estan en el offset del fichero: 0x015800


73D6123C   FF15 8463DF73    CALL DWORD PTR DS:[<&KERNEL32.CloseHandle>]  

Se cierra el manejador anterior para salvar ese volcado.


Mas tarde en el modulo del troyano:

00401E69  |> 8B4424 04      /MOV EAX,DWORD PTR SS:[ESP+4]                       ;  v030165.004068D0
00401E6D  |. 8D0C02         |LEA ECX,DWORD PTR DS:[EDX+EAX]
00401E70  |. 8AC2           |MOV AL,DL
00401E72  |. F6EA           |IMUL DL
00401E74  |. 3001           |XOR BYTE PTR DS:[ECX],AL
00401E76  |. 42             |INC EDX
00401E77  |. 3B5424 08      |CMP EDX,DWORD PTR SS:[ESP+8]
00401E7B  |.^7C EC          \JL SHORT v030165.00401E69

EAX = principio del volcado
ECX = principio del volcado + 1

Copiamos la parte baja de EDX a AL
Multiplicamos por el valor de DL lo que hay en EAX
quedando el resto en AL

Se hace un XOR col el resto al byte del volcado.

EDX vale el contador, cuando es igual al total de bytes del volcado
fin del bucle.

NOTA: Como se le suma el valor de EDX + EAX a ECX el recorrido
del volcado es lineal.

Se modifica el volcado anterior con esta rutina, lo que hace simplemente
es ir aplicandole XOR a cada byte a partir del segundo byte del volcado
partiendo del valor 1 en EDX, quedando el volcado finalmente:

004068D0  79 68 74 74 70 3A 2F 2F 63 35 2E 77 77 77 XX XX  yhttp://c5.wwwXX
004068E0  X XX XX 2E 69 6E 66 6F 2F 63 2E 70 68 70 00 00  XXX.info/c.php..
004068F0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406900  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406910  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406920  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406930  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406940  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406950  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406960  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406970  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406980  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00406990  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
004069A0  9A 99 99 99 99 99 C9 3F 00                       ......É?.

http://c5.wwwXXXXX.info/c.php <- es la web donde se envian los datos.

00405363   . 803D D0684000 >CMP BYTE PTR DS:[4068D0],79
0040536A   . 74 08          JE SHORT v030165.00405374

DS:[004068D0]=79 ('y')

004053F7   . 68 E4194000    PUSH v030165.004019E4                               
;  ASCII "SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\load"
004053FC   . E8 6F0A0000    CALL <JMP.&MFC42.#537>


00405420   . 68 D8194000    PUSH v030165.004019D8          
                     ;  ASCII "net_insll"
00405425   . E8 460A0000    CALL <JMP.&MFC42.#537>

0040548B   > 68 C8194000    PUSH v030165.004019C8        
                       ;  ASCII "\ipv6monl.dll"
00405490   . 8D4D E4        LEA ECX,DWORD PTR SS:[EBP-1C]
00405493   . E8 D8090000    CALL <JMP.&MFC42.#537>

Subrutina:
00401E80  /$ 55             PUSH EBP
00401E81  |. 8BEC           MOV EBP,ESP
00401E83  |. B8 08110000    MOV EAX,1108


00401F47  |> 8D85 F8FEFFFF  LEA EAX,DWORD PTR SS:[EBP-108]
00401F4D  |. 68 04010000    PUSH 104                                            ; /BufSize = 104 (260.)
00401F52  |. 50             PUSH EAX                                            ; |Buffer
00401F53  |. FF15 44104000  CALL DWORD PTR DS:[<&KERNEL32.GetSystemDirectoryA>] ; \GetSystemDirectoryA
Marco:
0012DDA0   0012EDB4  |Buffer = 0012EDB4
0012DDA4   00000104  \BufSize = 104 (260.)

Con esta API en este windows obtenemos:
0012EDB4  43 3A 5C 57 49 4E 44 4F 57 53 5C 73 79 73 74 65  C:\WINDOWS\syste
0012EDC4  6D 33 32                                         m32

00401FB4  |. E8 C33E0000    CALL <JMP.&MFC42.#6779>
Marco:
0012DDA0   00000000
0012DDA4   0012EDB4  ASCII "C:\WINDOWS\system32"

MFC:
73DA60E3   E8 16C6FAFF      CALL <JMP.&msvcrt.memcpy>

0012DD6C   00373B98  |dest = 00373B98
0012DD70   0012EDB4  |src = 0012EDB4
0012DD74   00000013  \n = 13 (19.)

00373B98  5C 69 70 76 36 6D 6F 6E 6C 2E 64 6C 6C 00 65 73  \ipv6monl.dll.es
00373BA8  5C 49 6E 5C 69 70 76 36 6D 6F 6E 6C 2E 64 6C 6C  \In\ipv6monl.dll
00373BB8  00 72 5C 49 45 58 50 4C                          .r\IEXPL

0012EDB4  43 3A 5C 57 49 4E 44 4F 57 53 5C 73 79 73 74 65  C:\WINDOWS\syste
0012EDC4  6D 33 32 00 51 69 6E 67 73 5C 41 64 6D 69 6E 69  m32.Qings\Admini
0012EDD4  73 74 72 61 64 6F                                strado


Quedando finalmente en el destino:
00373B98  43 3A 5C 57 49 4E 44 4F 57 53 5C 73 79 73 74 65  C:\WINDOWS\syste
00373BA8  6D 33 32 5C 69 70 76 36 6D 6F 6E 6C 2E 64 6C 6C  m32\ipv6monl.dll

Que es la ruta donde se instala el BHO ;-).

00405591   . E8 DA080000    CALL <JMP.&MFC42.#537>
Marco:
0012EEC0   004019C0  ASCII "RT_DLL"

Esta RT_DLL es la zona de la seccion .rsrc del PE32 donde se encuentra el BHO
veamos que hace con el:

00402292  |. FF75 10        PUSH DWORD PTR SS:[EBP+10]                          ; /ResourceType
00402295  |. 8B40 0C        MOV EAX,DWORD PTR DS:[EAX+C]                        ; |
00402298  |. 51             PUSH ECX                                            ; |ResourceName
00402299  |. 50             PUSH EAX                                            ; |hModule
0040229A  |. FF15 2C104000  CALL DWORD PTR DS:[<&KERNEL32.FindResourceA>]       ; \FindResourceA
Marco:
0012DA74   00400000  |hModule = 00400000 (v030165)
0012DA78   00000082  |ResourceName = 82
0012DA7C   00373BE8  \ResourceType = "RT_DLL"

Obtiene el manejador con exito y sigue... :-)

(COMO ODIO LA MFC GRRR)

0040231C  |. 56             PUSH ESI                                            ; /FailIfExists
0040231D  |. 8B35 40104000  MOV ESI,DWORD PTR DS:[<&KERNEL32.CopyFileA>]        ; |kernel32.CopyFileA
00402323  |. BF 30124000    MOV EDI,v030165.00401230                            ; |ASCII "2.html"
00402328  |. 53             PUSH EBX                                            ; |NewFileName => "c:\1z.txt"
00402329  |. 57             PUSH EDI                                            ; |ExistingFileName => "2.html"
0040232A  |. FFD6           CALL ESI                                            ; \CopyFileA
Marco:
0012DA74   00401230  |ExistingFileName = "2.html"
0012DA78   00401238  |NewFileName = "c:\1z.txt"
0012DA7C   00000001  \FailIfExists = TRUE

Este fichero no lo ha creado asi que la funcion falla :=?

0040233B  |. FF75 F0        PUSH DWORD PTR SS:[EBP-10]                          ; /hResource
0040233E  |. 8B40 0C        MOV EAX,DWORD PTR DS:[EAX+C]                        ; |
00402341  |. 50             PUSH EAX                                            ; |hModule
00402342  |. FF15 4C104000  CALL DWORD PTR DS:[<&KERNEL32.SizeofResource>]      ; \SizeofResource
Marco:
0012DA78   00400000  |hModule = 00400000 (v030165)
0012DA7C   00407048  \hResource = 00407048

El recurso ocupa: 0x0000F200 (EAX)

0040234B  |. FF15 CC114000  CALL DWORD PTR DS:[<&MSVCRT.rand>]                  ; [rand
00402351  |. 3D 00801294    CMP EAX,94128000
00402356  |. 75 0B          JNZ SHORT v030165.00402363
00402358  |. 68 A8010000    PUSH 1A8                                            ; /Timeout = 424. ms
0040235D  |. FF15 3C104000  CALL DWORD PTR DS:[<&KERNEL32.Sleep>]               ; \Sleep
00402363  |> E8 6E3B0000    CALL <JMP.&MFC42.#1168>

(En este caso el SLEEP no llega a ejecutarse.)

Y saltamos a otra MFC mas.... :`(

00402368  |. FF75 F0        PUSH DWORD PTR SS:[EBP-10]                          ; /hResource
0040236B  |. 8B40 0C        MOV EAX,DWORD PTR DS:[EAX+C]                        ; |
0040236E  |. 50             PUSH EAX                                            ; |hModule
0040236F  |. FF15 50104000  CALL DWORD PTR DS:[<&KERNEL32.LoadResource>]        ; \LoadResource
Marco:
0012DA78   00400000  |hModule = 00400000 (v030165)
0012DA7C   00407048  \hResource = 00407048

Recurso cargado :-)

004023DB  |. 50             PUSH EAX                                            ; /s
004023DC  |. FF15 B8114000  CALL DWORD PTR DS:[<&MSVCRT._strlwr>]               ; \_strlwr
Marco:
0012DA7C   0012DA8C  \s = ""

En MFC:

73D60EF5   FF15 E061DF73    CALL DWORD PTR DS:[<&KERNEL32.GetFullPathNameA>]    ; kernel32.GetFullPathNameA
Marco:
0012D7B8   00373B98  |FileName = "C:\WINDOWS\system32\ipv6monl.dll"
0012D7BC   00000104  |MaxPathSize = 104 (260.)
0012D7C0   0012D964  |Path = 0012D964
0012D7C4   0012D7D8  \pFilenameInPath = 0012D7D8

MFC:

73D60F45   FF15 DC61DF73    CALL DWORD PTR DS:[<&KERNEL32.GetVolumeInformationA>; kernel32.GetVolumeInformationA
Marco:
0012D7A8   00980058  |RootPathName = "C:\"
0012D7AC   00000000  |VolumeNameBuffer = NULL
0012D7B0   00000000  |MaxVolumeNameSize = 0
0012D7B4   00000000  |pVolumeSerialNumber = NULL
0012D7B8   0012D7D4  |pMaxFilenameLength = 0012D7D4
0012D7BC   0012D7DC  |pFileSystemFlags = 0012D7DC
0012D7C0   00000000  |pFileSystemNameBuffer = NULL
0012D7C4   00000000  \pFileSystemNameSize = NULL


MFC:

73D60E6D   FF15 C463DF73    CALL DWORD PTR DS:[<&KERNEL32.CreateFileA>]         ; kernel32.CreateFileA
Marco:
0012D928   00373B98  |FileName = "C:\WINDOWS\system32\ipv6monl.dll"
0012D92C   40000000  |Access = GENERIC_WRITE
0012D930   00000000  |ShareMode = 0
0012D934   0012D950  |pSecurity = 0012D950
0012D938   00000002  |Mode = CREATE_ALWAYS
0012D93C   00000080  |Attributes = NORMAL
0012D940   00000000  \hTemplateFile = NULL

(En la depuracion se ha creado para que falle la creacion y obtener el 
algoritmo por si existe).

Algoritmo de creacion de nombres para el BHO del troyano:

C:\WINDOWS\system32\ipv6monl.dll
C:\WINDOWS\system32\ipv6monk.dll
C:\WINDOWS\system32\ipv6monj.dll
C:\WINDOWS\system32\ipv6moni.dll
C:\WINDOWS\system32\ipv6monh.dll
C:\WINDOWS\system32\ipv6mong.dll
C:\WINDOWS\system32\ipv6monf.dll
C:\WINDOWS\system32\ipv6mone.dll
C:\WINDOWS\system32\ipv6mond.dll
C:\WINDOWS\system32\ipv6monc.dll
C:\WINDOWS\system32\ipv6monb.dll
C:\WINDOWS\system32\ipv6mona.dll
C:\WINDOWS\system32\ipv6mon`.dll
C:\WINDOWS\system32\ipv6mon_.dll
....

Sigue la tabla ASCII de forma inversa a partir de la letra l (0x6C)

Hasta que llega al 0x00 y ya rompe incluso la cadena de caracteres
no acabando en .DLL y metiendose en un bucle infinito :-).

(intenta crear por ultimo: C:\WINDOWS\system32\ipv6mon <- debido al NULL.)


En MFC:
73DAC521   FF15 C461DF73    CALL DWORD PTR DS:[<&KERNEL32.WriteFile>]           ; kernel32.WriteFile
Marco:
0012DA54   00000038  |hFile = 00000038
0012DA58   00407070  |Buffer = v030165.00407070
0012DA5C   0000F200  |nBytesToWrite = F200 (61952.)
0012DA60   0012DA7C  |pBytesWritten = 0012DA7C
0012DA64   00000000  \pOverlapped = NULL

Que corresponde con el fichero BHO en este caso ipv6monl, se escribe desde el offset 0
todo lo que hay en el recurso que pertenece a un PE32.

Y se escribe con exito :-).

En MFC:
73D6123C   FF15 8463DF73    CALL DWORD PTR DS:[<&KERNEL32.CloseHandle>]         ; kernel32.CloseHandle

Se cierra el manejador del BHO.


En el modulo del troyano:
00404247  |. 51             PUSH ECX                                            ; /pDisposition
00404248  |. 8D4D EC        LEA ECX,DWORD PTR SS:[EBP-14]                       ; |
0040424B  |. C645 FC 01     MOV BYTE PTR SS:[EBP-4],1                           ; |
0040424F  |. 51             PUSH ECX                                            ; |pHandle
00404250  |. 53             PUSH EBX                                            ; |pSecurity
00404251  |. 68 3F000F00    PUSH 0F003F                                         ; |Access = KEY_ALL_ACCESS
00404256  |. 53             PUSH EBX                                            ; |Options
00404257  |. 53             PUSH EBX                                            ; |Class
00404258  |. 53             PUSH EBX                                            ; |Reserved
00404259  |. 50             PUSH EAX                                            ; |Subkey
0040425A  |. 56             PUSH ESI                                            ; |hKey
0040425B  |. 895D EC        MOV DWORD PTR SS:[EBP-14],EBX                       ; |
0040425E  |. FF15 0C104000  CALL DWORD PTR DS:[<&ADVAPI32.RegCreateKeyExA>]     ; \RegCreateKeyExA
Marco:
0012DE70   80000002  |hKey = HKEY_LOCAL_MACHINE
0012DE74   00373B48  |Subkey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\load"
0012DE78   00000000  |Reserved = 0
0012DE7C   00000000  |Class = NULL
0012DE80   00000000  |Options = REG_OPTION_NON_VOLATILE
0012DE84   000F003F  |Access = KEY_ALL_ACCESS
0012DE88   00000000  |pSecurity = NULL
0012DE8C   0012EEA8  |pHandle = 0012EEA8
0012DE90   0012EEA4  \pDisposition = 0012EEA4


004042E0  |> FF75 08        PUSH DWORD PTR SS:[EBP+8]                           ; /ValueName
004042E3  |. 56             PUSH ESI                                            ; |hKey
004042E4  |. FF15 00104000  CALL DWORD PTR DS:[<&ADVAPI32.RegDeleteValueA>]     ; \RegDeleteValueA
Marco:
0012DE8C   00000038  |hKey = 38
0012DE90   00373BE8  \ValueName = "h"

Intenta eliminar la clave h de ... load :=?

004042EE  |. 56             PUSH ESI                                            ; /hKey
004042EF  |. FF15 14104000  CALL DWORD PTR DS:[<&ADVAPI32.RegCloseKey>]         ; \RegCloseKey

Cierra el manejador del registro que obtuvo antes.

Y cada vez que se accede al registro se abre la clave LOAD se hace lo pertinente y se vuelve
a cerrar:

004042E0  |> FF75 08        PUSH DWORD PTR SS:[EBP+8]                           ; /ValueName
004042E3  |. 56             PUSH ESI                                            ; |hKey
004042E4  |. FF15 00104000  CALL DWORD PTR DS:[<&ADVAPI32.RegDeleteValueA>]     ; \RegDeleteValueA
Marco:
0012DE8C   00000038  |hKey = 38
0012DE90   00373BE8  \ValueName = "wspopp"


Tambien intenta eliminar: 
forwas
nw

0040319C  |. 6A 01          PUSH 1                                   ; /FailIfExists = TRUE
0040319E  |. 68 38124000    PUSH v030165.00401238                    ; |NewFileName = "c:\1z.txt"
004031A3  |. 68 30124000    PUSH v030165.00401230                    ; |ExistingFileName = "2.html"
004031A8  |. FF15 40104000  CALL DWORD PTR DS:[<&KERNEL32.CopyFileA>>; \CopyFileA
Marco:
0011CA60   00401230  |ExistingFileName = "2.html"
0011CA64   00401238  |NewFileName = "c:\1z.txt"
0011CA68   00000001  \FailIfExists = TRUE

004031B1  |. FF15 E4114000  CALL DWORD PTR DS:[<&USER32.IsWindow>]   ; \IsWindow
0011CA68   00000000  \hWnd = NULL

0040323B  |. 50             PUSH EAX                                 ; /Arg3
0040323C  |. FF75 0C        PUSH DWORD PTR SS:[EBP+C]                ; |Arg2
0040323F  |. FF75 08        PUSH DWORD PTR SS:[EBP+8]                ; |Arg1
00403242  |. E8 F0FEFFFF    CALL v030165.00403137                    ; \v030165.00403137
Marco:
0011CA60   00373C88  |Arg1 = 00373C88 ASCII "http://c5.wwwXXXX.info/c.php"
0011CA64   0000001D  |Arg2 = 0000001D
0011CA68   0011DA78  \Arg3 = 0011DA78

ARG2= Tanyo de la cadena
ARG3=Buffer donde se crea la clave de cifrado

RUTINA de CIFRADO de la pagina del atacante:
00403151  |> 8B02           /MOV EAX,DWORD PTR DS:[EDX]
00403153  |. 0FB61E         |MOVZX EBX,BYTE PTR DS:[ESI]
00403156  |. 8BF8           |MOV EDI,EAX
00403158  |. 81E7 FF000000  |AND EDI,0FF
0040315E  |. 33FB           |XOR EDI,EBX
00403160  |. C1E8 08        |SHR EAX,8
00403163  |. 8B3CB9         |MOV EDI,DWORD PTR DS:[ECX+EDI*4]
00403166  |. 33F8           |XOR EDI,EAX
00403168  |. 46             |INC ESI
00403169  |. FF4D 08        |DEC DWORD PTR SS:[EBP+8]
0040316C  |. 893A           |MOV DWORD PTR DS:[EDX],EDI
0040316E  |.^75 E1          \JNZ SHORT v030165.00403151

ESI = http://c5.wwwXXXXX.info/c.php
EDX = Buffer donde se pone la clave de cifrado


EDX=0011DA78
0011DA78  8A B9 6A 44 84 31 40 00 B8 EE 12 00 45 3B 40 00  .¹jD.1@.¸î0011DA88  88 3C 37 00 1D 00 00 00 14 0C 00 00 64 BF 80 7C  .<7.......d¿.|
0011DA98  20 12 40 00 04 00 00 00 00 00 00 00 00 00 00 00   0011DAA8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAB8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAC8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAD8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAE8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAF8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB08  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB18  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB28  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB38  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................


Al final queda: 0011DA78  58 A1 5B 1C


00403C11  |> 8AC1           /MOV AL,CL
00403C13  |. F6E9           |IMUL CL
00403C15  |. 30840D E8EBFEF>|XOR BYTE PTR SS:[EBP+ECX+FFFEEBE8],AL
00403C1C  |. 8B42 F8        |MOV EAX,DWORD PTR DS:[EDX-8]
00403C1F  |. 41             |INC ECX
00403C20  |. 83C0 04        |ADD EAX,4
00403C23  |. 3BC8           |CMP ECX,EAX
00403C25  |.^72 EA          \JB SHORT v030165.00403C11

EDX = http://c5.wwwXXXXX.info/c.php
EBP+ECX+FFFEEBE8 = buffer donde se almacena la URL cifrada.


00403D66  |. 57             PUSH EDI                                 ; /pDisposition
00403D67  |. 52             PUSH EDX                                 ; |pHandle
00403D68  |. 8B48 04        MOV ECX,DWORD PTR DS:[EAX+4]             ; |
00403D6B  |. 57             PUSH EDI                                 ; |pSecurity
00403D6C  |. 68 06000200    PUSH 20006                               ; |Access = KEY_WRITE
00403D71  |. 57             PUSH EDI                                 ; |Options
00403D72  |. 57             PUSH EDI                                 ; |Class
00403D73  |. 57             PUSH EDI                                 ; |Reserved
00403D74  |. 51             PUSH ECX                                 ; |Subkey
00403D75  |. FF30           PUSH DWORD PTR DS:[EAX]                  ; |hKey
00403D77  |. FF15 0C104000  CALL DWORD PTR DS:[<&ADVAPI32.RegCreateK>; \RegCreateKeyExA

Marco:
0011DA70   80000002  |hKey = HKEY_LOCAL_MACHINE
0011DA74   00373B48  |Subkey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\load"
0011DA78   00000000  |Reserved = 0
0011DA7C   00000000  |Class = NULL
0011DA80   00000000  |Options = REG_OPTION_NON_VOLATILE
0011DA84   00020006  |Access = KEY_WRITE
0011DA88   00000000  |pSecurity = NULL
0011DA8C   0012EEA4  |pHandle = 0012EEA4
0011DA90   00000000  \pDisposition = NULL



00403DDD  |. 50             PUSH EAX                                 ; /BufSize
00403DDE  |. 8D85 E8EBFEFF  LEA EAX,DWORD PTR SS:[EBP+FFFEEBE8]      ; |
00403DE4  |. 50             PUSH EAX                                 ; |Buffer
00403DE5  |. 6A 03          PUSH 3                                   ; |ValueType = REG_BINARY
00403DE7  |. 57             PUSH EDI                                 ; |Reserved
00403DE8  |. FF75 08        PUSH DWORD PTR SS:[EBP+8]                ; |ValueName
00403DEB  |. FF75 EC        PUSH DWORD PTR SS:[EBP-14]               ; |hKey
00403DEE  |. FF15 10104000  CALL DWORD PTR DS:[<&ADVAPI32.RegSetValu>; \RegSetValueExA
Marco:
0011DA7C   0000003C  |hKey = 3C
0011DA80   00373C38  |ValueName = "worg"
0011DA84   00000000  |Reserved = 0
0011DA88   00000003  |ValueType = REG_BINARY
0011DA8C   0011DAA0  |Buffer = 0011DAA0
0011DA90   00000021  \BufSize = 21 (33.)

0011DAA0:
A7 5E A4 E3 78 6D 50 41 7A 7E 4B 1A A5 87 B3 96 77 00 00 00 00 00 CA 78 2E 17 CB F6 73 67 F4 A9
70 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00

Parece ser que aqui esta la URL cifrada donde se envia la informacion.

00403FDA  |. 51             PUSH ECX                                 ; /pHandle
00403FDB  |. 68 19000200    PUSH 20019                               ; |Access = KEY_READ
00403FE0  |. 8B47 04        MOV EAX,DWORD PTR DS:[EDI+4]             ; |
00403FE3  |. 6A 00          PUSH 0                                   ; |Reserved = 0
00403FE5  |. 50             PUSH EAX                                 ; |Subkey
00403FE6  |. FF37           PUSH DWORD PTR DS:[EDI]                  ; |hKey
00403FE8  |. FF15 04104000  CALL DWORD PTR DS:[<&ADVAPI32.RegOpenKey>; \RegOpenKeyExA
Marco:
0011DA78   80000002  |hKey = HKEY_LOCAL_MACHINE
0011DA7C   00373B48  |Subkey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\load"
0011DA80   00000000  |Reserved = 0
0011DA84   00020019  |Access = KEY_READ
0011DA88   0012EE9C  \pHandle = 0012EE9C

00403FF9  |. 50             PUSH EAX                                 ; /pBufSize
00403FFA  |. 8D85 E0EBFEFF  LEA EAX,DWORD PTR SS:[EBP+FFFEEBE0]      ; |
00404000  |. 50             PUSH EAX                                 ; |Buffer
00404001  |. 6A 00          PUSH 0                                   ; |pValueType = NULL
00404003  |. 6A 00          PUSH 0                                   ; |Reserved = NULL
00404005  |. FF75 0C        PUSH DWORD PTR SS:[EBP+C]                ; |ValueName
00404008  |. FF75 E4        PUSH DWORD PTR SS:[EBP-1C]               ; |hKey
0040400B  |. FF15 08104000  CALL DWORD PTR DS:[<&ADVAPI32.RegQueryVa>; \RegQueryValueExA
Marco:
0011DA74   0000003C  |hKey = 3C
0011DA78   00373C88  |ValueName = "cmpid"
0011DA7C   00000000  |Reserved = NULL
0011DA80   00000000  |pValueType = NULL
0011DA84   0011DA98  |Buffer = 0011DA98
0011DA88   0012EEA4  \pBufSize = 0012EEA4


Se descifra lo que hay en el campo cmpid:

00404091  |> 8AC1           /MOV AL,CL
00404093  |. F6E9           |IMUL CL
00404095  |. 30840D E0EBFEF>|XOR BYTE PTR SS:[EBP+ECX+FFFEEBE0],AL
0040409C  |. 41             |INC ECX
0040409D  |. 3B4D EC        |CMP ECX,DWORD PTR SS:[EBP-14]
004040A0  |.^72 EF          \JB SHORT v030165.00404091

Quedando finalmente:
0011DA98  61 28 7D 1D 41 41 44 31 32 37 30 33 38 38 35 37  a(}AAD127038857
0011DAA8  34 41 39 42 41 32 30 41 31 31 45 35 45 32 41 32  4A9BA20A11E5E2A2
0011DAB8  32 34 42 39 34 31 41 31 44 41 38 45 36 44 39 37  24B941A1DA8E6D97
0011DAC8  34 41 35 34 41 33 32 31 32 45 38 46 35 37 46 46  4A54A3212E8F57FF
0011DAD8  39 43 45 34 00 00 00 00 00 00 00 00 00 00 00 00  9CE4............


0011DA80   0011DA9C  ASCII "AAD1270388574A9BA20A11E5E2A224B941A1DA8E6D974A54A3212E8F57FF9CE4"

0040323B  |. 50             PUSH EAX                                 ; /Arg3
0040323C  |. FF75 0C        PUSH DWORD PTR SS:[EBP+C]                ; |Arg2
0040323F  |. FF75 08        PUSH DWORD PTR SS:[EBP+8]                ; |Arg1
00403242  |. E8 F0FEFFFF    CALL v030165.00403137                    ; \v030165.00403137
Marco:
0011CA58   0011DA9C  |Arg1 = 0011DA9C ASCII "AAD1270388574A9BA20A11E5E2A224B941A1DA8E6D974A54A3212E8F57FF9CE4"
0011CA5C   00000040  |Arg2 = 00000040
0011CA60   0011DA70  \Arg3 = 0011DA70


00403151  |> 8B02           /MOV EAX,DWORD PTR DS:[EDX]
00403153  |. 0FB61E         |MOVZX EBX,BYTE PTR DS:[ESI]
00403156  |. 8BF8           |MOV EDI,EAX
00403158  |. 81E7 FF000000  |AND EDI,0FF
0040315E  |. 33FB           |XOR EDI,EBX
00403160  |. C1E8 08        |SHR EAX,8
00403163  |. 8B3CB9         |MOV EDI,DWORD PTR DS:[ECX+EDI*4]
00403166  |. 33F8           |XOR EDI,EAX
00403168  |. 46             |INC ESI
00403169  |. FF4D 08        |DEC DWORD PTR SS:[EBP+8]
0040316C  |. 893A           |MOV DWORD PTR DS:[EDX],EDI
0040316E  |.^75 E1          \JNZ SHORT v030165.00403151

EAX 00000040
ECX 0012DA98
EDX 0011DA70
EBX 00000001
ESP 0011CA44
EBP 0011CA50
ESI 0011DA9C ASCII "AAD1270388574A9BA20A11E5E2A224B941A1DA8E6D974A54A3212E8F57FF9CE4"
EDI 00000000


73D611C4   FF15 8C63DF73    CALL DWORD PTR DS:[<&KERNEL32.SetFilePoi>; kernel32.SetFilePointer
Marco:
0012EA6C   0000003C  |hFile = 0000003C (window)
0012EA70   00000000  |OffsetLo = 0
0012EA74   00000000  |pOffsetHi = NULL
0012EA78   00000002  \Origin = FILE_END

(ipv6monl.dll)

73DAC521   FF15 C461DF73    CALL DWORD PTR DS:[<&KERNEL32.WriteFile>>; kernel32.WriteFile
Marco:
0012EA60   0000003C  |hFile = 0000003C (window)
0012EA64   004068D0  |Buffer = v030165.004068D0
0012EA68   000000D8  |nBytesToWrite = D8 (216.)
0012EA6C   0012EA88  |pBytesWritten = 0012EA88
0012EA70   00000000  \pOverlapped = NULL


00402228  |. FFD6           CALL ESI                                 ; \_strlwr
Marco:
0012EA88   0012EA94  \s = "Ã¸Ã â€”|hÃ®


004047E6  |. 68 24164000    PUSH v030165.00401624                    ;  ASCII "{7836z4D99-Az240-4zdff-B11A-67E44z8373045}"
004047EB  |. E8 80160000    CALL <JMP.&MFC42.#537>

0040446E  |. 68 E8144000    PUSH v030165.004014E8                    ;  ASCII "SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\browser helper obJects\"
00404473  |. 50             PUSH EAX


00404492  |> BE C0134000    MOV ESI,v030165.004013C0                 ;  ASCII " The African Union said Tuesday its troops will leave Darfur by the end of the month unless Sudan drops its opposition to the deployment of U.N. peacekeepers, and U.N. chief Kofi Annan warned Khartoum it bears full responsibility for the"...
00404497  |. B8 08134000    MOV EAX,v030165.00401308                 ;  ASCII ""It's where the person gets up in front of the camera and really almost looks the camera in the eye and says, 'I really screwed up. I know I screwed up. Please forgive me,'" he said."
0040449C  |> 8A10           /MOV DL,BYTE PTR DS:[EAX]
0040449E  |. 8ACA           |MOV CL,DL
004044A0  |. 3A16           |CMP DL,BYTE PTR DS:[ESI]
004044A2  |. 75 1A          |JNZ SHORT v030165.004044BE
004044A4  |. 3ACB           |CMP CL,BL
004044A6  |. 74 12          |JE SHORT v030165.004044BA
004044A8  |. 8A50 01        |MOV DL,BYTE PTR DS:[EAX+1]
004044AB  |. 8ACA           |MOV CL,DL
004044AD  |. 3A56 01        |CMP DL,BYTE PTR DS:[ESI+1]
004044B0  |. 75 0C          |JNZ SHORT v030165.004044BE
004044B2  |. 40             |INC EAX
004044B3  |. 40             |INC EAX
004044B4  |. 46             |INC ESI
004044B5  |. 46             |INC ESI
004044B6  |. 3ACB           |CMP CL,BL
004044B8  |.^75 E2          \JNZ SHORT v030165.0040449C

00404645  |. 50             PUSH EAX                                 ; /pHandle
00404646  |. 68 06000200    PUSH 20006                               ; |Access = KEY_WRITE
0040464B  |. 53             PUSH EBX                                 ; |Reserved
0040464C  |. FF75 E4        PUSH DWORD PTR SS:[EBP-1C]               ; |Subkey
0040464F  |. 68 02000080    PUSH 80000002                            ; |hKey = HKEY_LOCAL_MACHINE
00404654  |. FF15 04104000  CALL DWORD PTR DS:[<&ADVAPI32.RegOpenKey>; \RegOpenKeyExA
Marco:
0012CE40   80000002  |hKey = HKEY_LOCAL_MACHINE
0012CE44   00374FA8  |Subkey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\browser helper obJects"
0012CE48   00000000  |Reserved = 0
0012CE4C   00020006  |Access = KEY_WRITE
0012CE50   0012DE68  \pHandle = 0012DE68

004046AC  |. FF75 E0        PUSH DWORD PTR SS:[EBP-20]               ; /SubKey
004046AF  |. C645 FC 03     MOV BYTE PTR SS:[EBP-4],3                ; |
004046B3  |. FF75 E8        PUSH DWORD PTR SS:[EBP-18]               ; |hKey
004046B6  |. FF15 D4114000  CALL DWORD PTR DS:[<&SHLWAPI.SHDeleteKey>; \SHDeleteKeyA
Marco:
0012CE4C   0000003C  |hKey = 3C
0012CE50   00377338  \SubKey = "{7836L6@2Å b4D99-AL6@2Å b240-4L6@2Å bdff-B11A-67E44L6@2Å b8373045}"

00404645  |. 50             PUSH EAX                                 ; /pHandle
00404646  |. 68 06000200    PUSH 20006                               ; |Access = KEY_WRITE
0040464B  |. 53             PUSH EBX                                 ; |Reserved
0040464C  |. FF75 E4        PUSH DWORD PTR SS:[EBP-1C]               ; |Subkey
0040464F  |. 68 02000080    PUSH 80000002                            ; |hKey = HKEY_LOCAL_MACHINE
00404654  |. FF15 04104000  CALL DWORD PTR DS:[<&ADVAPI32.RegOpenKey>; \RegOpenKeyExA
Marco:
0012CE40   80000002  |hKey = HKEY_LOCAL_MACHINE
0012CE44   00374FA8  |Subkey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\browser helper obJects"
0012CE48   00000000  |Reserved = 0
0012CE4C   00020006  |Access = KEY_WRITE
0012CE50   0012DE68  \pHandle = 0012DE68

00404945  |. 51             PUSH ECX                                 ; /pDisposition
00404946  |. 8D4D F0        LEA ECX,DWORD PTR SS:[EBP-10]            ; |
00404949  |. 8B35 0C104000  MOV ESI,DWORD PTR DS:[<&ADVAPI32.RegCrea>; |ADVAPI32.RegCreateKeyExA
0040494F  |. 51             PUSH ECX                                 ; |pHandle
00404950  |. 53             PUSH EBX                                 ; |pSecurity
00404951  |. 68 3F000F00    PUSH 0F003F                              ; |Access = KEY_ALL_ACCESS
00404956  |. 53             PUSH EBX                                 ; |Options
00404957  |. 53             PUSH EBX                                 ; |Class
00404958  |. 53             PUSH EBX                                 ; |Reserved
00404959  |. 50             PUSH EAX                                 ; |Subkey => "SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\browser helper obJects\L6@2Å b{73L6@2Å b364D99-12L6@2Å b40-4dL6@2Å bff-B1L6@2Å b1A-67E448373048}"
0040495A  |. 68 02000080    PUSH 80000002                            ; |hKey = HKEY_LOCAL_MACHINE
0040495F  |. 895D F0        MOV DWORD PTR SS:[EBP-10],EBX            ; |
00404962  |. FFD6           CALL ESI                                 ; \RegCreateKeyExA

registro de BHO:

70212.46875000	v030165.exe:2684	OpenKey	HKCU\Software\Classes\AppID\L6@2Å b{73L6@2Å b364D99-12L6@2Å b40-4dL6@2Å bff-B1L6@2Å b1A-67E448373048}	NOT FOUND		
70212.46875000	v030165.exe:2684	OpenKey	HKCR	SUCCESS	Access: 0x2000000 	
70212.46875000	v030165.exe:2684	CreateKey	HKCR\AppID\L6@2Å b{73L6@2Å b364D99-12L6@2Å b40-4dL6@2Å bff-B1L6@2Å b1A-67E448373048}	SUCCESS	Access: 0xF003F 	
70212.46875000	v030165.exe:2684	CloseKey	HKCR	SUCCESS		
70218.31250000	v030165.exe:2684	CloseKey	HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\browser helper obJects\L6@2Å b{73L6@2Å b364D99-12L6@2Å b40-4dL6@2Å bff-B1L6@2Å b1A-67E448373048}	SUCCESS		
70493.46093750	v030165.exe:2684	CreateKey	HKCR\CLSID\L6@2Å b{73L6@2Å b364D99-12L6@2Å b40-4dL6@2Å bff-B1L6@2Å b1A-67E448373048}	SUCCESS	Access: 0xF003F 	



Primer salto cuando depuramos de la MFC X al modulo del troyano:
73D5CF71   FF50 58          CALL DWORD PTR DS:[EAX+58]                                                ; v030165.00405106


00402D7D  |. 50             PUSH EAX                                                                  ; /pDisposition
00402D7E  |. 8D45 F0        LEA EAX,DWORD PTR SS:[EBP-10]                                             ; |
00402D81  |. 50             PUSH EAX                                                                  ; |pHandle
00402D82  |. 53             PUSH EBX                                                                  ; |pSecurity
00402D83  |. 68 3F000F00    PUSH 0F003F                                                               ; |Access = KEY_ALL_ACCESS
00402D88  |. 53             PUSH EBX                                                                  ; |Options
00402D89  |. 53             PUSH EBX                                                                  ; |Class
00402D8A  |. 53             PUSH EBX                                                                  ; |Reserved
00402D8B  |. 68 8C124000    PUSH v030165.0040128C                                                     ; |Subkey = "System\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\AuthorizedApplications\List"
00402D90  |. 68 02000080    PUSH 80000002                                                             ; |hKey = HKEY_LOCAL_MACHINE
00402D95  |. FF15 0C104000  CALL DWORD PTR DS:[<&ADVAPI32.RegCreateKeyExA>]                           ; \RegCreateKeyExA
Marco:
0012DE44   80000002  |hKey = HKEY_LOCAL_MACHINE
0012DE48   0040128C  |Subkey = "System\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\AuthorizedApplications\List"
0012DE4C   00000000  |Reserved = 0
0012DE50   00000000  |Class = NULL
0012DE54   00000000  |Options = REG_OPTION_NON_VOLATILE
0012DE58   000F003F  |Access = KEY_ALL_ACCESS
0012DE5C   00000000  |pSecurity = NULL
0012DE60   0012EEA8  |pHandle = 0012EEA8
0012DE64   0012EEA0  \pDisposition = 0012EEA0

00402DB4  |. E8 2F310000    CALL <JMP.&MFC42.#924_??H@YG?AVCString@@ABV0@PBD@Z>
Marco:
0012DE54   0012EEA0
0012DE58   0012EEC0
0012DE5C   00401280  ASCII ":*:Enabled:"
0012DE60   00401C24  ASCII "Typically, that's where no one dashes to rehab or uses the word "if." According to Slansky, conditional apologies usually fail, as when Allen tried to apologize for calling an Indian-American man "macaca" by saying, "If I had any idea it"...
0012DE64   00401B30  ASCII "Sudan on Monday gave the AU a one-week ultimatum to accept a deal that would block the proposed 20,000-member U.N. peacekeeping force in Darfur or else leave the region, a step that would likely worsen the world's worst humanitarian disa"...
0012DE68   00000004

Se obtiene por la pila:
00373B50  43 3A 5C 50 72 6F 67 72 61 6D 20 46 69 6C 65 73  C:\Program Files
00373B60  5C 49 6E 74 65 72 6E 65 74 20 45 78 70 6C 6F 72  \Internet Explor
00373B70  65 72 5C 49 45 58 50 4C 4F 52 45 2E 45 58 45 3A  er\IEXPLORE.EXE:
00373B80  2A 3A 45 6E 61 62 6C 65 64 3A                    *:Enabled:

00402DC6  |. E8 17310000    CALL <JMP.&MFC42.#922_??H@YG?AVCString@@ABV0@0@Z>
Marco:
0012DE54   0012EEA8
0012DE58   0012EEA0
0012DE5C   0012EEC4
0012DE60   00401C24  ASCII "Typically, that's where no one dashes to rehab or uses the word "if." According to Slansky, conditional apologies usually fail, as when Allen tried to apologize for calling an Indian-American man "macaca" by saying, "If I had any idea it"...
0012DE64   00401B30  ASCII "Sudan on Monday gave the AU a one-week ultimatum to accept a deal that would block the proposed 20,000-member U.N. peacekeeping force in Darfur or else leave the region, a step that would likely worsen the world's worst humanitarian disa"...

Y por la pila:
0012DE3C   00374ED0  ASCII "C:\Program Files\Internet Explorer\IEXPLORE.EXE:*:Enabled:Internet Explorer"

00402DD8  |. 50             PUSH EAX                                                                  ; /BufSize
00402DD9  |. 56             PUSH ESI                                                                  ; |Buffer
00402DDA  |. 6A 01          PUSH 1                                                                    ; |ValueType = REG_SZ
00402DDC  |. 53             PUSH EBX                                                                  ; |Reserved
00402DDD  |. 57             PUSH EDI                                                                  ; |ValueName
00402DDE  |. FF75 EC        PUSH DWORD PTR SS:[EBP-14]                                                ; |hKey
00402DE1  |. FF15 10104000  CALL DWORD PTR DS:[<&ADVAPI32.RegSetValueExA>]                            ; \RegSetValueExA
Marco:
0012DE48   00000038  |hKey = 38
0012DE4C   00373AB0  |ValueName = "C:\Program Files\Internet Explorer\IEXPLORE.EXE"
0012DE50   00000000  |Reserved = 0
0012DE54   00000001  |ValueType = REG_SZ
0012DE58   00374ED0  |Buffer = 00374ED0
0012DE5C   0000004C  \BufSize = 4C (76.)
Info:
00374ED0  43 3A 5C 50 72 6F 67 72 61 6D 20 46 69 6C 65 73  C:\Program Files
00374EE0  5C 49 6E 74 65 72 6E 65 74 20 45 78 70 6C 6F 72  \Internet Explor
00374EF0  65 72 5C 49 45 58 50 4C 4F 52 45 2E 45 58 45 3A  er\IEXPLORE.EXE:
00374F00  2A 3A 45 6E 61 62 6C 65 64 3A 49 6E 74 65 72 6E  *:Enabled:Intern
00374F10  65 74 20 45 78 70 6C 6F 72 65 72 00 0D F0        et Explorer..Ã°

00402E02  |. FF75 EC        PUSH DWORD PTR SS:[EBP-14]                                                ; /hKey
00402E05  |. FF15 14104000  CALL DWORD PTR DS:[<&ADVAPI32.RegCloseKey>]                               ; \RegCloseKey

(1176.84350586	v030165.exe:3896	CloseKey	HKLM\System\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\AuthorizedApplications\List	SUCCESS		
)

0040368F  |. 50             PUSH EAX                                                                  ; /timer
00403690  |. FF15 C8114000  CALL DWORD PTR DS:[<&MSVCRT.time>]                                        ; \time
Marco:
0012DE80   0012EEA0  \timer = 0012EEA0

00403A72  |. FF15 04104000  CALL DWORD PTR DS:[<&ADVAPI32.RegOpenKeyExA>]                             ; \RegOpenKeyExA
MArco:
0012DE58   80000002  |hKey = HKEY_LOCAL_MACHINE
0012DE5C   00373B00  |Subkey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Control Panel\load"
0012DE60   00000000  |Reserved = 0
0012DE64   0002001F  |Access = KEY_QUERY_VALUE|KEY_SET_VALUE|KEY_CREATE_SUB_KEY|KEY_ENUMERATE_SUB_KEYS|KEY_NOTIFY|20000
0012DE68   0012DE70  \pHandle = 0012DE70

004039A2  |. FF15 10104000  CALL DWORD PTR DS:[<&ADVAPI32.RegSetValueExA>]                            ; \RegSetValueExA
Marco:
0012DE6C   00000038  |hKey = 38
0012DE70   00373B50  |ValueName = "net_insll"
0012DE74   00000000  |Reserved = 0
0012DE78   00000004  |ValueType = REG_DWORD
0012DE7C   0012EEC4  |Buffer = 0012EEC4
0012DE80   00000004  \BufSize = 4

00403151  |> 8B02           /MOV EAX,DWORD PTR DS:[EDX]
00403153  |. 0FB61E         |MOVZX EBX,BYTE PTR DS:[ESI]
00403156  |. 8BF8           |MOV EDI,EAX
00403158  |. 81E7 FF000000  |AND EDI,0FF
0040315E  |. 33FB           |XOR EDI,EBX
00403160  |. C1E8 08        |SHR EAX,8
00403163  |. 8B3CB9         |MOV EDI,DWORD PTR DS:[ECX+EDI*4]
00403166  |. 33F8           |XOR EDI,EAX
00403168  |. 46             |INC ESI
00403169  |. FF4D 08        |DEC [ARG.1]
0040316C  |. 893A           |MOV DWORD PTR DS:[EDX],EDI
0040316E  |.^75 E1          \JNZ SHORT v030165.00403151

[ARG.1] = 0000001D (longitud de la cadena: apuntada por ESI  )


EAX = 0000001D
ECX = 0012DAA0
EDX = 0011DA78
EBX = 00000004
ESP = 0011CA4C
EBP = 0011CA58
ESI = 00373C40
EDI = 00000000

ECX = 
00 00 00 00 96 30 07 77 2C 61 0E EE BA 51 09 99 19 C4 6D 07 8F F4 6A 70 35 A5 63 E9 A3 95 64 9E
32 88 DB 0E A4 B8 DC 79 1E E9 D5 E0 88 D9 D2 97 2B 4C B6 09 BD 7C B1 7E 07 2D B8 E7 91 1D BF 90
64 10 B7 1D F2 20 B0 6A 48 71 B9 F3 DE 41 BE 84 7D D4 DA 1A EB E4 DD 6D 51 B5 D4 F4 C7 85 D3 83
56 98 6C 13 C0 A8 6B 64 7A F9 62 FD EC C9 65 8A 4F 5C 01 14 D9 6C 06 63 63 3D 0F FA F5 0D 08 8D
C8 20 6E 3B 5E 10 69 4C E4 41 60 D5 72 71 67 A2 D1 E4 03 3C 47 D4 04 4B FD 85 0D D2 6B B5 0A A5
FA A8 B5 35 6C 98 B2 42 D6 C9 BB DB 40 F9 BC AC E3 6C D8 32 75 5C DF 45 CF 0D D6 DC 59 3D D1 AB
AC 30 D9 26 3A 00 DE 51 80 51 D7 C8 16 61 D0 BF B5 F4 B4 21 23 C4 B3 56 99 95 BA CF 0F A5 BD B8
9E B8 02 28 08 88 05 5F B2 D9 0C C6 24 E9 0B B1 87 7C 6F 2F 11 4C 68 58 AB 1D 61 C1 3D 2D 66 B6
90 41 DC 76 06 71 DB 01 BC 20 D2 98 2A 10 D5 EF 89 85 B1 71 1F B5 B6 06 A5 E4 BF 9F 33 D4 B8 E8
A2 C9 07 78 34 F9 00 0F 8E A8 09 96 18 98 0E E1 BB 0D 6A 7F 2D 3D 6D 08 97 6C 64 91 01 5C 63 E6
F4 51 6B 6B 62 61 6C 1C D8 30 65 85 4E 00 62 F2 ED 95 06 6C 7B A5 01 1B C1 F4 08 82 57 C4 0F F5
C6 D9 B0 65 50 E9 B7 12 EA B8 BE 8B 7C 88 B9 FC DF 1D DD 62 49 2D DA 15 F3 7C D3 8C 65 4C D4 FB
58 61 B2 4D CE 51 B5 3A 74 00 BC A3 E2 30 BB D4 41 A5 DF 4A D7 95 D8 3D 6D C4 D1 A4 FB F4 D6 D3
6A E9 69 43 FC D9 6E 34 46 88 67 AD D0 B8 60 DA 73 2D 04 44 E5 1D 03 33 5F 4C 0A AA C9 7C 0D DD
3C 71 05 50 AA 41 02 27 10 10 0B BE 86 20 0C C9 25 B5 68 57 B3 85 6F 20 09 D4 66 B9 9F E4 61 CE
0E F9 DE 5E 98 C9 D9 29 22 98 D0 B0 B4 A8 D7 C7 17 3D B3 59 81 0D B4 2E 3B 5C BD B7 AD 6C BA C0
20 83 B8 ED B6 B3 BF 9A 0C E2 B6 03 9A D2 B1 74 39 47 D5 EA AF 77 D2 9D 15 26 DB 04 83 16 DC 73
12 0B 63 E3 84 3B 64 94 3E 6A 6D 0D A8 5A 6A 7A 0B CF 0E E4 9D FF 09 93 27 AE 00 0A B1 9E 07 7D
44 93 0F F0 D2 A3 08 87 68 F2 01 1E FE C2 06 69 5D 57 62 F7 CB 67 65 80 71 36 6C 19 E7 06 6B 6E
76 1B D4 FE E0 2B D3 89 5A 7A DA 10 CC 4A DD 67 6F DF B9 F9 F9 EF BE 8E 43 BE B7 17 D5 8E B0 60
E8 A3 D6 D6 7E 93 D1 A1 C4 C2 D8 38 52 F2 DF 4F F1 67 BB D1 67 57 BC A6 DD 06 B5 3F 4B 36 B2 48
DA 2B 0D D8 4C 1B 0A AF F6 4A 03 36 60 7A 04 41 C3 EF 60 DF 55 DF 67 A8 EF 8E 6E 31 79 BE 69 46
8C B3 61 CB 1A 83 66 BC A0 D2 6F 25 36 E2 68 52 95 77 0C CC 03 47 0B BB B9 16 02 22 2F 26 05 55
BE 3B BA C5 28 0B BD B2 92 5A B4 2B 04 6A B3 5C A7 FF D7 C2 31 CF D0 B5 8B 9E D9 2C 1D AE DE 5B
B0 C2 64 9B 26 F2 63 EC 9C A3 6A 75 0A 93 6D 02 A9 06 09 9C 3F 36 0E EB 85 67 07 72 13 57 00 05
82 4A BF 95 14 7A B8 E2 AE 2B B1 7B 38 1B B6 0C 9B 8E D2 92 0D BE D5 E5 B7 EF DC 7C 21 DF DB 0B
D4 D2 D3 86 42 E2 D4 F1 F8 B3 DD 68 6E 83 DA 1F CD 16 BE 81 5B 26 B9 F6 E1 77 B0 6F 77 47 B7 18
E6 5A 08 88 70 6A 0F FF CA 3B 06 66 5C 0B 01 11 FF 9E 65 8F 69 AE 62 F8 D3 FF 6B 61 45 CF 6C 16
78 E2 0A A0 EE D2 0D D7 54 83 04 4E C2 B3 03 39 61 26 67 A7 F7 16 60 D0 4D 47 69 49 DB 77 6E 3E
4A 6A D1 AE DC 5A D6 D9 66 0B DF 40 F0 3B D8 37 53 AE BC A9 C5 9E BB DE 7F CF B2 47 E9 FF B5 30
1C F2 BD BD 8A C2 BA CA 30 93 B3 53 A6 A3 B4 24 05 36 D0 BA 93 06 D7 CD 29 57 DE 54 BF 67 D9 23
2E 7A 66 B3 B8 4A 61 C4 02 1B 68 5D 94 2B 6F 2A 37 BE 0B B4 A1 8E 0C C3 1B DF 05 5A 8D EF 02 2D
00 7E 00 00 00 7E 00 00 00 00 00 00 64 00 00 00 7A 00 00 00 00 7E 00 00 00 00 00 00 00 00 00 00
7A 00 00 00 47 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 47 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 77 00 00 00 77 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 77 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00


EDX =
FF FF FF FF 84 31 40 00 B8 EE 12 00 45 3B 40 00 40 3C 37 00 1D 00 00 00 14 0C 00 00 64 BF 80 7C
20 12 40 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00

ESI = 
00373C40  68 74 74 70 3A 2F 2F 63 35 2E 77 77 77 00 00 00  http://c5.wwwXXX
00373C50  00 00 2E 69 6E 66 6F 2F 63 2E 70 68 70 00 AD BA  XX.info/c.php.Â­Âº
00373C60  0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0        .Ã°Â­Âº.Ã°Â­Âº.Ã°Â­Âº.Ã°


Finalmente la clave creada es: 
0011DA78  58 A1 5B 1C



00403C11  |> 8AC1           /MOV AL,CL
00403C13  |. F6E9           |IMUL CL
00403C15  |. 30840D E8EBFEF>|XOR BYTE PTR SS:[EBP+ECX+FFFEEBE8],AL
00403C1C  |. 8B42 F8        |MOV EAX,DWORD PTR DS:[EDX-8]
00403C1F  |. 41             |INC ECX
00403C20  |. 83C0 04        |ADD EAX,4
00403C23  |. 3BC8           |CMP ECX,EAX
00403C25  |.^72 EA          \JB SHORT v030165.00403C11

EAX = 00000021
ECX = 00000004 
EDX = 00373C40 
EBX = 00000004
ESP = 0011DA94
EBP = 0012EEB8
ESI = 00373C5E
EDI = 0011DAC2

EDX =
00373C40  68 74 74 70 3A 2F 2F 63 35 2E 77 77 77 34 XX XX  http://c5.www4XX
00373C50  XX XX 2E 69 6E 66 6F 2F 63 2E 70 68 70 00 AD BA  XX.info/c.php.Â­Âº

ESI =
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA D4 3C 37 00 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 24 3D 37 00 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 74 3D 37 00 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA C4 3D 37 00 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0 AD BA 0D F0
AD BA 0D F0 AD BA 14 3E 37 00 0D F0 AD BA

EDI =
0011DAC2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAD2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAE2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DAF2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB02  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB12  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB22  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB32  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB42  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB52  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB62  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB72  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB82  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DB92  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DBA2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DBB2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DBC2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DBD2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DBE2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DBF2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC02  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC12  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC22  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC32  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC42  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC52  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC62  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC72  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC82  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DC92  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DCA2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DCB2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DCC2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DCD2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DCE2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DCF2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD02  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD12  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD22  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD32  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD42  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD52  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD62  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD72  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD82  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DD92  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DDA2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DDB2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DDC2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DDD2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DDE2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DDF2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE02  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE12  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE22  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE32  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE42  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE52  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE62  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE72  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE82  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DE92  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0011DEA2  00 00 00 00 00 00 00 00 00 00 00 00 00 00        ..............

EDX - 8: 
1D 00 00 00 



Quedando finalmente cifrado:
A7 5E A4 E3 78 6D 50 41 7A 7E 4B 1A A5 87 B3 96 77 00 00 00
00 00 CA 78 2E 17 CB F6 73 67 F4 A9 70 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00



00403DDD  |. 50             PUSH EAX                                                   ; /BufSize
00403DDE  |. 8D85 E8EBFEFF  LEA EAX,[LOCAL.17670]                                      ; |
00403DE4  |. 50             PUSH EAX                                                   ; |Buffer
00403DE5  |. 6A 03          PUSH 3                                                     ; |ValueType = REG_BINARY
00403DE7  |. 57             PUSH EDI                                                   ; |Reserved
00403DE8  |. FF75 08        PUSH [ARG.1]                                               ; |ValueName
00403DEB  |. FF75 EC        PUSH [LOCAL.5]                                             ; |hKey
00403DEE  |. FF15 10104000  CALL DWORD PTR DS:[<&ADVAPI32.RegSetValueExA>]             ; \RegSetValueExA
Marco:
0011DA7C   0000003C  |hKey = 3C
0011DA80   00373BF0  |ValueName = "worg"
0011DA84   00000000  |Reserved = 0
0011DA88   00000003  |ValueType = REG_BINARY
0011DA8C   0011DAA0  |Buffer = 0011DAA0
0011DA90   00000021  \BufSize = 21 (33.)


Es decir worg contiene la url donde se envia la informacion cifrado :-).


